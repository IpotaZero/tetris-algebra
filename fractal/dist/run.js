class u{static#n={color:"black",width:4,anchorA:"center",anchorB:"center",arrow:!1};static#r=null;static#h(){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.id="connector-layer",Object.assign(e.style,{position:"fixed",inset:"0",width:"100vw",height:"100vh",pointerEvents:"none"});const t=this.#l(e),s=document.createElementNS(e.namespaceURI,"defs");return s.appendChild(t),e.appendChild(s),e}static#l(e){const t=document.createElementNS(e.namespaceURI,"marker");t.id="arrow-end",t.setAttribute("orient","auto"),t.setAttribute("markerWidth","4"),t.setAttribute("markerHeight","4"),t.setAttribute("refX","1"),t.setAttribute("refY","2");const s=document.createElementNS(e.namespaceURI,"path");return s.setAttribute("d",`M 0 0
             Q 2 1.3, 4 2
             Q 2 2.7, 0 4
             Z`),s.setAttribute("fill","currentColor"),t.appendChild(s),t}static ensureLayer(){return this.#r||(this.#r=this.#h()),this.#r}line;hitLine;options;#t;#e;#s;#a;#i=null;constructor(e,t,s={}){this.#t=e,this.#e=t,this.options={...u.#n,...s};const i=u.ensureLayer();this.hitLine=this.#u(i),i.appendChild(this.hitLine),this.line=this.#c(i),i.appendChild(this.line),this.#m(),this.update()}#c(e){const t=document.createElementNS(e.namespaceURI,"polyline");return t.setAttribute("stroke","currentColor"),t.setAttribute("stroke-width",String(this.options.width)),t.setAttribute("stroke-linecap","round"),this.options.arrow&&t.setAttribute("marker-mid","url(#arrow-end)"),t.style.pointerEvents="none",t}#u(e){const t=document.createElementNS(e.namespaceURI,"line");return t.setAttribute("stroke","transparent"),t.setAttribute("stroke-width",String(this.options.width*8)),t.setAttribute("stroke-linecap","round"),t.style.pointerEvents="stroke",t}#m(){const e=this.update.bind(this);window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("resize",e,{passive:!0}),this.#s=new ResizeObserver(e),this.#a=new ResizeObserver(e),this.#s.observe(this.#t),this.#a.observe(this.#e)}#p(e,t){const s=e.getBoundingClientRect();switch(t){case"center":return{x:s.left+s.width/2,y:s.top+s.height/2};case"top":return{x:s.left+s.width/2,y:s.top};case"bottom":return{x:s.left+s.width/2,y:s.bottom};case"left":return{x:s.left,y:s.top+s.height/2};case"right":return{x:s.right,y:s.top+s.height/2}}}update(){this.#i===null&&(this.#i=requestAnimationFrame(()=>{const e=this.#p(this.#t,this.options.anchorA),t=this.#p(this.#e,this.options.anchorB);this.line.setAttribute("points",`${e.x},${e.y} ${(e.x+t.x)/2},${(e.y+t.y)/2} ${t.x},${t.y}`),this.hitLine.setAttribute("x1",String(e.x)),this.hitLine.setAttribute("y1",String(e.y)),this.hitLine.setAttribute("x2",String(t.x)),this.hitLine.setAttribute("y2",String(t.y)),this.#i=null}))}destroy(){window.removeEventListener("scroll",this.update),window.removeEventListener("resize",this.update),this.#s.disconnect(),this.#a.disconnect(),this.line.remove(),this.hitLine.remove()}}class x{tree=[];#n=7;#r;#h=new Map;#l=[];#t;#e;#s=new Map;#a=0;history=[];#i=0;top=10;constructor(e,t){this.#r=e,this.#e=t,e.innerHTML=`
            <div id="context-menu">
                <button>追加</button>
                <button>消す</button>
                <button>これ以下を木にする</button>
                <button>この頂点をマークする/外す</button>
            </div>
        `,this.#t=e.querySelector("#context-menu"),this.#t.style.display="none",document.body.append(this.#t),this.#r.addEventListener("pointerdown",()=>{this.#t.style.display="none"})}undo(){this.#i!==0&&(this.#i--,this.tree=JSON.parse(this.history[this.#i]),this.display(!1))}redo(){this.#i!==this.history.length-1&&(this.#i++,this.tree=JSON.parse(this.history[this.#i]),this.display(!1))}divide(){this.#c(this.tree),this.display()}#c(e){e.length===1?e[0].length===0?e.splice(0,1):this.#c(e[0]):e.length===2&&(e[1].length===0?e.splice(0,1):this.#c(e[1]),e[0].length===0?e.splice(0,1):this.#c(e[0]))}cut(){this.tree=JSON.parse(JSON.stringify(this.getCut(this.tree))),this.display()}getCut(e){if(e.length===0)return[];if(e.length===1)return[this.getCut(e[0]),e[0]];if(e.length===2)return[this.getCut(e[1]),e[1]];throw new SyntaxError("ミツマタが発生!")}display(e=!0){e&&(this.history=this.history.slice(0,this.#i+1),this.history.push(JSON.stringify(this.tree)),this.#i=this.history.length-1),this.#t.style.display="none",this.#h.forEach(i=>i.destroy()),this.#h.clear(),this.#e.innerHTML="",this.#e.innerHTML=this.stringify()+"<br>",this.#e.innerHTML+=JSON.stringify(this.tree)+"<br>",this.#e.innerHTML+=`階層: ${this.#f(this.tree)??"一意でない"}<br>`,this.#e.innerHTML+=`準フラクタル？ ${this.isSemiFractal()}<br>`,this.#e.innerHTML+=`C(W)=W？ ${JSON.stringify(this.getCut(this.tree))===JSON.stringify(this.tree)}<br>`,this.#e.innerHTML+=`<textarea rows="5">${this.history.map(i=>JSON.stringify(i).slice(1,-1)).join(`
`)}</textarea> <br>`,this.#r.appendChild(u.ensureLayer()),this.folder();const t=document.createElement("span");t.classList.add("vertex"),t.id="",t.style.top=this.top+"%",this.#l.push(t),this.#r.appendChild(t);const s=this.#y(this.tree,t);t.style.left=`calc(30% + ${s}px)`,this.#l.forEach(i=>{i.onclick=n=>{n.target===i&&this.#u(i.id)},i.oncontextmenu=n=>{n.target===i&&(n.preventDefault(),this.#t.style.display="flex",this.#t.style.left=n.clientX+"px",this.#t.style.top=n.clientY+"px",this.#t.querySelector(":nth-child(1)").onclick=()=>{this.#u(i.id)},this.#t.querySelector(":nth-child(2)").onclick=()=>{this.#m(i.id)},this.#t.querySelector(":nth-child(3)").onclick=()=>{this.#p(i.id)},this.#t.querySelector(":nth-child(4)").onclick=()=>{this.#s.get(i.id)?this.#s.delete(i.id):this.#s.set(i.id,`oklch(70% 0.2 ${this.#a++*67})`),this.display(!1)})}})}#u(e){let t=this.tree;for(const s of e)t=t[Number(s)];if(t.length==2){t.splice(0,2),this.display();return}t.push([]),this.display()}#m(e){let t=this.tree;for(const s of e.slice(0,-1))t=t[Number(s)];t.splice(+e.charAt(-1),1),this.display()}#p(e){let t=this.tree;for(const s of e)t=t[Number(s)];this.tree=t,this.display()}#y(e,t,s=""){if(e.length===0)return 2*this.#n;if(e.length===1){const i=document.createElement("span");i.classList.add("vertex"),i.style.left="0px",i.style.top=this.#n*4+"px",i.id=s+"0";const n=this.#s.get(i.id);n&&(i.style.backgroundColor=n),this.#l.push(i),t.appendChild(i);const r=new u(t,i);return r.line.classList.add("blue"),this.#h.set([t,i],r),this.#y(e[0],i,s+"0")}else if(e.length===2){const i=document.createElement("span");i.classList.add("vertex"),i.style.top=this.#n*4+"px",i.id=s+"0";const n=this.#s.get(i.id);n&&(i.style.backgroundColor=n),this.#l.push(i),t.appendChild(i);const r=new u(t,i);r.line.classList.add("orange"),this.#h.set([t,i],r);const d=this.#y(e[0],i,s+"0"),o=document.createElement("span");o.classList.add("vertex"),o.style.top=this.#n*4+"px",o.id=s+"1";const c=this.#s.get(o.id);c&&(o.style.backgroundColor=c),this.#l.push(o),t.appendChild(o);const a=new u(t,o);a.line.classList.add("red"),this.#h.set([t,o],a);const f=this.#y(e[1],o,s+"1"),p=d+f-this.#n;return i.style.left=-p-this.#n+"px",o.style.left=p+this.#n+"px",d+f}else throw new SyntaxError("ミツマタが発生!")}stringify(){return this.#d(this.tree,"")}#d(e,t){const s=["#D6D848","#CC76D1","#4A9DF8"][t.length%3],i=n=>`<span style="color: ${s}">${n}</span>`;if(e.length===0){const n=this.#s.get(t);return n?`<span style="color: ${n};">0</span>`:"0"}else{if(e.length===1)return`${i("(")}${this.#d(e[0],t+0)}${i(")")}`;if(e.length===2)return`${i("[")}${this.#d(e[0],t+0)},${this.#d(e[1],t+1)}${i("]")}`}throw new SyntaxError("ミツマタが発生!")}isFractal(){return this.isSemiFractal()&&JSON.stringify(this.tree)===JSON.stringify(this.getCut(this.tree))}isSemiFractal(){let e=1;for(;;){const t=this.#g(this.tree,e);if(t.length===0)break;if(!t.every(n=>n.length===0)&&t.some(n=>n.length===0))return!1;const s=t[0].join();if(!t.slice(1).every(n=>n.join()===s))return!1;e++}return!0}#f(e){if(e.length===0)return 0;if(e.length===1){const t=this.#f(e[0]);return t===null?null:t+1}else if(e.length===2){const t=this.#f(e[0]),s=this.#f(e[1]);return t!==s||t===null?null:t+1}throw new Error("ミツマタが発生!")}#g(e,t){if(t===1){if(e.length===1)return[e[0]];if(e.length===2)return[e[1]]}if(e.length===0)return[];if(e.length===1)return this.#g(e[0],t-1);if(e.length===2)return[...this.#g(e[0],t-1),...this.#g(e[1],t-1)];throw new Error("なんかおかしい!")}folder(){this.#o(this.tree,this.#e)}#o(e,t,s=0,i=""){const n=document.createElement("button");n.innerHTML=`${this.#d(e,i)}`;const r=document.createElement("div");r.classList.add("hidden","layer"),r.dataset.depth="2em";let d=!1;const o=()=>{if(d=!0,e.length===1){const c=document.createElement("span");c.textContent="...",c.classList.add("dot"),r.appendChild(c),this.#o(e[0],r,s+1,i+0),this.#o(e[0],r,s+1,i+0),this.#o(e[0],r,s+1,i+0);const a=document.createElement("span");a.textContent="...",a.classList.add("dot"),r.appendChild(a)}else if(e.length===2){this.#o(e[0],r,s+1,i+0),this.#o(e[1],r,s+1,i+1),this.#o(e[1],r,s+1,i+1),this.#o(e[1],r,s+1,i+1);const c=document.createElement("span");c.textContent="...",c.classList.add("dot"),r.appendChild(c)}};n.onclick=()=>{d||o(),r.classList.toggle("hidden")},t.appendChild(n),t.appendChild(r)}}document.addEventListener("DOMContentLoaded",async()=>{const l=document.getElementById("container"),e=document.getElementById("info"),t=new x(l,e);t.display();const s=document.getElementById("form"),i=document.getElementById("input"),n=document.getElementById("divide");n.onclick=()=>{t.divide()};const r=document.getElementById("cut");r.onclick=()=>{t.cut()};const d=document.getElementById("copy");d.onclick=()=>{i.value=JSON.stringify(t.tree)},document.getElementById("undo").onclick=()=>{t.undo()},window.addEventListener("keydown",h=>{h.ctrlKey&&h.code==="KeyZ"&&t.undo(),h.ctrlKey&&h.code==="KeyY"&&t.redo(),h.ctrlKey&&h.code==="KeyC"&&navigator.clipboard.writeText(JSON.stringify(t.tree))}),document.getElementById("redo").onclick=()=>{t.redo()},window.tree=t,s.onsubmit=h=>{h.preventDefault();const y=i.value.replaceAll(`
`,"").replaceAll("0","[]").replaceAll("(","[").replaceAll(")","]");t.tree=JSON.parse(y),t.display()};const o=new x(l,e),a=(await navigator.mediaDevices.getDisplayMedia({video:!0})).getVideoTracks()[0],f=new window.ImageCapture(a);await new Promise(h=>setTimeout(h,2e3));const p=0,k=800;for(const h of m(5))if(t.tree=h,t.isSemiFractal()){o.tree=t.getCut(h),o.top=40,l.innerHTML="",t.display(),o.display(),await new Promise(v=>requestAnimationFrame(v)),await new Promise(v=>requestAnimationFrame(v));const y=await f.grabFrame(),w=y.width-p,b=y.height-k,g=document.createElement("canvas");g.width=w,g.height=b;const L=g.getContext("2d");if(!L)throw new Error("Canvas context not available");L.drawImage(y,p,0,w,b,0,0,w,b),C(g.toDataURL("image/png"),JSON.stringify(h))}a.stop()});function*m(l){if(l===0){yield[];return}for(const e of m(l-1))yield[e];for(const e of m(l-1))for(const t of m(l-1))yield[e,t]}function C(l,e){const t=document.createElement("a");t.href=l,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)}
//# sourceMappingURL=run.js.map
