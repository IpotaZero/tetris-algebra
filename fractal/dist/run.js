class d{static#e={color:"black",width:4,anchorA:"center",anchorB:"center",arrow:!1};static#t=null;static#i(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.id="connector-layer",Object.assign(t.style,{position:"fixed",inset:"0",width:"100vw",height:"100vh",pointerEvents:"none"});const e=this.#o(t),i=document.createElementNS(t.namespaceURI,"defs");return i.appendChild(e),t.appendChild(i),t}static#o(t){const e=document.createElementNS(t.namespaceURI,"marker");e.id="arrow-end",e.setAttribute("orient","auto"),e.setAttribute("markerWidth","4"),e.setAttribute("markerHeight","4"),e.setAttribute("refX","1"),e.setAttribute("refY","2");const i=document.createElementNS(t.namespaceURI,"path");return i.setAttribute("d",`M 0 0
             Q 2 1.3, 4 2
             Q 2 2.7, 0 4
             Z`),i.setAttribute("fill","currentColor"),e.appendChild(i),e}static ensureLayer(){return this.#t||(this.#t=this.#i()),this.#t}line;hitLine;options;#s;#h;#l;#r;#c=null;constructor(t,e,i={}){this.#s=t,this.#h=e,this.options={...d.#e,...i};const s=d.ensureLayer();this.hitLine=this.#a(s),s.appendChild(this.hitLine),this.line=this.#u(s),s.appendChild(this.line),this.#d(),this.update()}#u(t){const e=document.createElementNS(t.namespaceURI,"polyline");return e.setAttribute("stroke","currentColor"),e.setAttribute("stroke-width",String(this.options.width)),e.setAttribute("stroke-linecap","round"),this.options.arrow&&e.setAttribute("marker-mid","url(#arrow-end)"),e.style.pointerEvents="none",e}#a(t){const e=document.createElementNS(t.namespaceURI,"line");return e.setAttribute("stroke","transparent"),e.setAttribute("stroke-width",String(this.options.width*8)),e.setAttribute("stroke-linecap","round"),e.style.pointerEvents="stroke",e}#d(){const t=this.update.bind(this);window.addEventListener("scroll",t,{passive:!0}),window.addEventListener("resize",t,{passive:!0}),this.#l=new ResizeObserver(t),this.#r=new ResizeObserver(t),this.#l.observe(this.#s),this.#r.observe(this.#h)}#n(t,e){const i=t.getBoundingClientRect();switch(e){case"center":return{x:i.left+i.width/2,y:i.top+i.height/2};case"top":return{x:i.left+i.width/2,y:i.top};case"bottom":return{x:i.left+i.width/2,y:i.bottom};case"left":return{x:i.left,y:i.top+i.height/2};case"right":return{x:i.right,y:i.top+i.height/2}}}update(){this.#c===null&&(this.#c=requestAnimationFrame(()=>{const t=this.#n(this.#s,this.options.anchorA),e=this.#n(this.#h,this.options.anchorB);this.line.setAttribute("points",`${t.x},${t.y} ${(t.x+e.x)/2},${(t.y+e.y)/2} ${e.x},${e.y}`),this.hitLine.setAttribute("x1",String(t.x)),this.hitLine.setAttribute("y1",String(t.y)),this.hitLine.setAttribute("x2",String(e.x)),this.hitLine.setAttribute("y2",String(e.y)),this.#c=null}))}destroy(){window.removeEventListener("scroll",this.update),window.removeEventListener("resize",this.update),this.#l.disconnect(),this.#r.disconnect(),this.line.remove(),this.hitLine.remove()}}class p{tree=[];history=[];#e=0;#t;constructor(t,e){this.#t=new f(t,e)}undo(){this.#e!==0&&(this.#e--,this.tree=JSON.parse(this.history[this.#e]),this.display(!1))}redo(){this.#e!==this.history.length-1&&(this.#e++,this.tree=JSON.parse(this.history[this.#e]),this.display(!1))}divide(){h.divide(this.tree),this.display()}cut(){this.tree=JSON.parse(JSON.stringify(h.cut(this.tree))),this.display()}display(t=!0){t&&this.#o(),this.#t.display(this.tree),this.#t.setupLeft(this.tree,this.history),this.#i()}#i(){this.#t.vertices.forEach(t=>{t.onclick=e=>{e.target===t&&this.#s(t.id)},t.oncontextmenu=e=>{if(e.target!==t)return;e.preventDefault(),this.#t.contextMenu.style.display="flex",this.#t.contextMenu.style.left=e.clientX+"px",this.#t.contextMenu.style.top=e.clientY+"px";const i=this.#t.contextMenu;i.querySelector(":nth-child(1)").onclick=()=>{this.#s(t.id)},i.querySelector(":nth-child(2)").onclick=()=>{this.#h(t.id)},i.querySelector(":nth-child(3)").onclick=()=>{this.#l(t.id)},i.querySelector(":nth-child(4)").onclick=()=>{this.#t.toggleColor(t.id),this.display(!1)}}})}#o(){this.history=this.history.slice(0,this.#e+1),this.history.push(JSON.stringify(this.tree)),this.#e=this.history.length-1}#s(t){let e=this.tree;for(const i of t)e=e[Number(i)];if(e.length==2){e.splice(0,2),this.display();return}e.push([]),this.display()}#h(t){let e=this.tree;for(const i of t.slice(0,-1))e=e[Number(i)];e.splice(+t.charAt(-1),1),this.display()}#l(t){let e=this.tree;for(const i of t)e=e[Number(i)];this.tree=e,this.display()}isFractal(){return h.isSemiFractal(this.tree)&&this.invariantToCut()}invariantToCut(){return JSON.stringify(this.tree)===JSON.stringify(h.cut(this.tree))}}class f{top=100;vertices=new Map;contextMenu;#e=6;#t;#i;#o=new Map;#s=new Map;#h=0;constructor(t,e){this.#t=t,this.#i=e,this.#l()}toggleColor(t){this.#s.get(t)?this.#s.delete(t):this.#s.set(t,`oklch(70% 0.2 ${this.#h++*67})`)}display(t){this.#u(),this.#t.appendChild(d.ensureLayer());const e=this.#c(),i=this.#i.getBoundingClientRect();let s=t;for(;s.length!==0;)s=s[0];const r=this.#r(t,e,"",0);for(let n=0;n<3;n++)e.style.left=`calc(${i.width*1.1}px + ${r.left}px)`}#l(){this.#t.innerHTML=`
            <div id="context-menu">
                <button>追加</button>
                <button>消す</button>
                <button>これ以下を木にする</button>
                <button>この頂点をマークする/外す</button>
            </div>
        `,this.contextMenu=this.#t.querySelector("#context-menu"),this.contextMenu.style.display="none",document.body.append(this.contextMenu),this.#t.addEventListener("pointerdown",()=>{this.contextMenu.style.display="none"})}#r(t,e,i,s){if(t.length===0)return{right:this.#e*2,left:this.#e*2};if(t.length===1){const r=this.#a(e,i+"0","blue");return this.#r(t[0],r,i+"0",0)}else if(t.length===2){const r=this.#a(e,i+"0","orange"),n=this.#r(t[0],r,i+"0",1),l=this.#a(e,i+"1","red"),o=this.#r(t[1],l,i+"1",2),c=n.right+this.#e,a=o.left+this.#e;return r.style.left=-c+"px",l.style.left=a+"px",{left:c+n.left,right:a+o.right}}throw new SyntaxError("ミツマタが発生!")}#c(){const t=this.#d(this.top,0,"");return this.#t.appendChild(t),t}#u(){this.contextMenu.style.display="none",this.#o.forEach(t=>t.destroy()),this.#o.clear(),this.vertices.clear(),this.#t.innerHTML="",this.#i.innerHTML=""}#a(t,e,i){const s=this.#d(this.#e*4*2/Math.sqrt(3),0,e);t.appendChild(s);const r=new d(t,s);return r.line.classList.add(i),this.#o.set([t,s],r),s}#d(t,e,i){const s=document.createElement("span");s.classList.add("vertex"),s.style.top=`${t}px`,s.style.left=`${e}px`,s.id=i;const r=this.#s.get(s.id);return r&&(s.style.backgroundColor=r),this.vertices.set(s.id,s),s}folder(t){this.#n(t,this.#i)}#n(t,e,i=0,s=""){const r=document.createElement("button");r.innerHTML=`${this.stringify(t,s)}`;const n=document.createElement("div");n.classList.add("hidden","layer"),n.dataset.depth="2em";let l=!1;const o=()=>{const a=document.createElement("span");return a.textContent="...",a.classList.add("dot"),a},c=()=>{l=!0,t.length===1?(n.appendChild(o()),this.#n(t[0],n,i+1,s+0),this.#n(t[0],n,i+1,s+0),this.#n(t[0],n,i+1,s+0),n.appendChild(o())):t.length===2&&(this.#n(t[0],n,i+1,s+0),this.#n(t[1],n,i+1,s+1),this.#n(t[1],n,i+1,s+1),this.#n(t[1],n,i+1,s+1),n.appendChild(o()))};r.onclick=()=>{l||c(),n.classList.toggle("hidden")},e.appendChild(r),e.appendChild(n)}stringify(t,e=""){const i=["#D6D848","#CC76D1","#4A9DF8"][e.length%3],s=r=>`<span style="color: ${i}">${r}</span>`;if(t.length===0){const r=this.#s.get(e);return r?`<span style="color: ${r};">0</span>`:"0"}else{if(t.length===1)return`${s("(")}${this.stringify(t[0],e+0)}${s(")")}`;if(t.length===2)return`${s("[")}${this.stringify(t[0],e+0)},${this.stringify(t[1],e+1)}${s("]")}`}throw new SyntaxError("ミツマタが発生!")}setupLeft(t,e){this.#i.innerHTML="",this.#i.innerHTML+=this.stringify(t)+"<br>",this.#i.innerHTML+=JSON.stringify(t)+"<br>",this.#i.innerHTML+=`階層: ${h.countRank(t)??"一意でない"}<br>`,this.#i.innerHTML+=`準フラクタル？ ${h.isSemiFractal(t)}<br>`,this.#i.innerHTML+=`C(W)=W？ ${JSON.stringify(h.cut(t))===JSON.stringify(t)}<br>`,this.#i.innerHTML+=`<textarea rows="5">${e.map(i=>JSON.stringify(i).slice(1,-1)).join(`
`)}</textarea> <br>`,this.folder(t)}}class h{static countRank(t){if(t.length===0)return 0;if(t.length===1){const e=this.countRank(t[0]);return e===null?null:e+1}else if(t.length===2){const e=this.countRank(t[0]),i=this.countRank(t[1]);return e!==i||e===null?null:e+1}throw new Error("ミツマタが発生!")}static getRankNTrees(t,e){if(e===1){if(t.length===1)return[t[0]];if(t.length===2)return[t[1]]}if(t.length===0)return[];if(t.length===1)return this.getRankNTrees(t[0],e-1);if(t.length===2)return[...this.getRankNTrees(t[0],e-1),...this.getRankNTrees(t[1],e-1)];throw new Error("なんかおかしい!")}static cut(t){if(t.length===0)return[];if(t.length===1)return[this.cut(t[0]),t[0]];if(t.length===2)return[this.cut(t[1]),t[1]];throw new SyntaxError("ミツマタが発生!")}static divide(t){t.length===1?t[0].length===0?t.splice(0,1):this.divide(t[0]):t.length===2&&(t[1].length===0?t.splice(0,1):this.divide(t[1]),t[0].length===0?t.splice(0,1):this.divide(t[0]))}static isSemiFractal(t){let e=1;for(;;){const i=h.getRankNTrees(t,e);if(i.length===0)break;if(!i.every(n=>n.length===0)&&i.some(n=>n.length===0))return!1;const s=i[0].join();if(!i.slice(1).every(n=>n.join()===s))return!1;e++}return!0}}document.addEventListener("DOMContentLoaded",async()=>{const u=document.getElementById("container"),t=document.getElementById("info"),e=new p(u,t);e.display();const i=document.getElementById("form"),s=document.getElementById("input"),r=document.getElementById("divide");r.onclick=()=>{e.divide()};const n=document.getElementById("cut");n.onclick=()=>{e.cut()};const l=document.getElementById("copy");l.onclick=()=>{s.value=JSON.stringify(e.tree)},document.getElementById("undo").onclick=()=>{e.undo()},window.addEventListener("keydown",o=>{o.ctrlKey&&o.code==="KeyZ"&&e.undo(),o.ctrlKey&&o.code==="KeyY"&&e.redo(),o.ctrlKey&&o.code==="KeyC"&&navigator.clipboard.writeText(JSON.stringify(e.tree))}),document.getElementById("redo").onclick=()=>{e.redo()},window.tree=e,i.onsubmit=o=>{o.preventDefault();const c=s.value.replaceAll(`
`,"").replaceAll("0","[]").replaceAll("(","[").replaceAll(")","]");e.tree=JSON.parse(c),e.display()}});
//# sourceMappingURL=run.js.map
