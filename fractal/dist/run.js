class c{static#n={color:"black",width:4,anchorA:"center",anchorB:"center",arrow:!1};static#r=null;static#h(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.id="connector-layer",Object.assign(t.style,{position:"fixed",inset:"0",width:"100vw",height:"100vh",pointerEvents:"none"});const e=this.#l(t),s=document.createElementNS(t.namespaceURI,"defs");return s.appendChild(e),t.appendChild(s),t}static#l(t){const e=document.createElementNS(t.namespaceURI,"marker");e.id="arrow-end",e.setAttribute("orient","auto"),e.setAttribute("markerWidth","4"),e.setAttribute("markerHeight","4"),e.setAttribute("refX","1"),e.setAttribute("refY","2");const s=document.createElementNS(t.namespaceURI,"path");return s.setAttribute("d",`M 0 0
             Q 2 1.3, 4 2
             Q 2 2.7, 0 4
             Z`),s.setAttribute("fill","currentColor"),e.appendChild(s),e}static ensureLayer(){return this.#r||(this.#r=this.#h()),this.#r}line;hitLine;options;#t;#e;#s;#d;#i=null;constructor(t,e,s={}){this.#t=t,this.#e=e,this.options={...c.#n,...s};const i=c.ensureLayer();this.hitLine=this.#u(i),i.appendChild(this.hitLine),this.line=this.#c(i),i.appendChild(this.line),this.#m(),this.update()}#c(t){const e=document.createElementNS(t.namespaceURI,"polyline");return e.setAttribute("stroke","currentColor"),e.setAttribute("stroke-width",String(this.options.width)),e.setAttribute("stroke-linecap","round"),this.options.arrow&&e.setAttribute("marker-mid","url(#arrow-end)"),e.style.pointerEvents="none",e}#u(t){const e=document.createElementNS(t.namespaceURI,"line");return e.setAttribute("stroke","transparent"),e.setAttribute("stroke-width",String(this.options.width*8)),e.setAttribute("stroke-linecap","round"),e.style.pointerEvents="stroke",e}#m(){const t=this.update.bind(this);window.addEventListener("scroll",t,{passive:!0}),window.addEventListener("resize",t,{passive:!0}),this.#s=new ResizeObserver(t),this.#d=new ResizeObserver(t),this.#s.observe(this.#t),this.#d.observe(this.#e)}#p(t,e){const s=t.getBoundingClientRect();switch(e){case"center":return{x:s.left+s.width/2,y:s.top+s.height/2};case"top":return{x:s.left+s.width/2,y:s.top};case"bottom":return{x:s.left+s.width/2,y:s.bottom};case"left":return{x:s.left,y:s.top+s.height/2};case"right":return{x:s.right,y:s.top+s.height/2}}}update(){this.#i===null&&(this.#i=requestAnimationFrame(()=>{const t=this.#p(this.#t,this.options.anchorA),e=this.#p(this.#e,this.options.anchorB);this.line.setAttribute("points",`${t.x},${t.y} ${(t.x+e.x)/2},${(t.y+e.y)/2} ${e.x},${e.y}`),this.hitLine.setAttribute("x1",String(t.x)),this.hitLine.setAttribute("y1",String(t.y)),this.hitLine.setAttribute("x2",String(e.x)),this.hitLine.setAttribute("y2",String(e.y)),this.#i=null}))}destroy(){window.removeEventListener("scroll",this.update),window.removeEventListener("resize",this.update),this.#s.disconnect(),this.#d.disconnect(),this.line.remove(),this.hitLine.remove()}}class y{tree=[];#n=7;#r;#h=new Map;#l=[];#t;#e;#s=new Map;#d=0;history=[];#i=0;top=10;constructor(t,e){this.#r=t,this.#e=e,t.innerHTML=`
            <div id="context-menu">
                <button>追加</button>
                <button>消す</button>
                <button>これ以下を木にする</button>
                <button>この頂点をマークする/外す</button>
            </div>
        `,this.#t=t.querySelector("#context-menu"),this.#t.style.display="none",document.body.append(this.#t),this.#r.addEventListener("pointerdown",()=>{this.#t.style.display="none"})}undo(){this.#i!==0&&(this.#i--,this.tree=JSON.parse(this.history[this.#i]),this.display(!1))}redo(){this.#i!==this.history.length-1&&(this.#i++,this.tree=JSON.parse(this.history[this.#i]),this.display(!1))}divide(){this.#c(this.tree),this.display()}#c(t){t.length===1?t[0].length===0?t.splice(0,1):this.#c(t[0]):t.length===2&&(t[1].length===0?t.splice(0,1):this.#c(t[1]),t[0].length===0?t.splice(0,1):this.#c(t[0]))}cut(){this.tree=JSON.parse(JSON.stringify(this.getCut(this.tree))),this.display()}getCut(t){if(t.length===0)return[];if(t.length===1)return[this.getCut(t[0]),t[0]];if(t.length===2)return[this.getCut(t[1]),t[1]];throw new SyntaxError("ミツマタが発生!")}display(t=!0){t&&(this.history=this.history.slice(0,this.#i+1),this.history.push(JSON.stringify(this.tree)),this.#i=this.history.length-1),this.#t.style.display="none",this.#h.forEach(i=>i.destroy()),this.#h.clear(),this.#r.innerHTML="",this.#e.innerHTML="",this.#e.innerHTML=this.stringify()+"<br>",this.#e.innerHTML+=JSON.stringify(this.tree)+"<br>",this.#e.innerHTML+=`階層: ${this.#f(this.tree)??"一意でない"}<br>`,this.#e.innerHTML+=`準フラクタル？ ${this.isSemiFractal()}<br>`,this.#e.innerHTML+=`C(W)=W？ ${JSON.stringify(this.getCut(this.tree))===JSON.stringify(this.tree)}<br>`,this.#e.innerHTML+=`<textarea rows="5">${this.history.map(i=>JSON.stringify(i).slice(1,-1)).join(`
`)}</textarea> <br>`,this.#r.appendChild(c.ensureLayer()),this.folder();const e=document.createElement("span");e.classList.add("vertex"),e.id="",e.style.top=this.top+"%",this.#l.push(e),this.#r.appendChild(e);const s=this.#y(this.tree,e);e.style.left=`calc(40% + ${s}px)`,this.#l.forEach(i=>{i.onclick=n=>{n.target===i&&this.#u(i.id)},i.oncontextmenu=n=>{n.target===i&&(n.preventDefault(),this.#t.style.display="flex",this.#t.style.left=n.clientX+"px",this.#t.style.top=n.clientY+"px",this.#t.querySelector(":nth-child(1)").onclick=()=>{this.#u(i.id)},this.#t.querySelector(":nth-child(2)").onclick=()=>{this.#m(i.id)},this.#t.querySelector(":nth-child(3)").onclick=()=>{this.#p(i.id)},this.#t.querySelector(":nth-child(4)").onclick=()=>{this.#s.get(i.id)?this.#s.delete(i.id):this.#s.set(i.id,`oklch(70% 0.2 ${this.#d++*67})`),this.display(!1)})}})}#u(t){let e=this.tree;for(const s of t)e=e[Number(s)];if(e.length==2){e.splice(0,2),this.display();return}e.push([]),this.display()}#m(t){let e=this.tree;for(const s of t.slice(0,-1))e=e[Number(s)];e.splice(+t.charAt(-1),1),this.display()}#p(t){let e=this.tree;for(const s of t)e=e[Number(s)];this.tree=e,this.display()}#y(t,e,s=""){if(t.length===0)return 2*this.#n;if(t.length===1){const i=document.createElement("span");i.classList.add("vertex"),i.style.left="0px",i.style.top=this.#n*4+"px",i.id=s+"0";const n=this.#s.get(i.id);n&&(i.style.backgroundColor=n),this.#l.push(i),e.appendChild(i);const r=new c(e,i);return r.line.classList.add("blue"),this.#h.set([e,i],r),this.#y(t[0],i,s+"0")}else if(t.length===2){const i=document.createElement("span");i.classList.add("vertex"),i.style.top=this.#n*4+"px",i.id=s+"0";const n=this.#s.get(i.id);n&&(i.style.backgroundColor=n),this.#l.push(i),e.appendChild(i);const r=new c(e,i);r.line.classList.add("orange"),this.#h.set([e,i],r);const l=this.#y(t[0],i,s+"0"),o=document.createElement("span");o.classList.add("vertex"),o.style.top=this.#n*4+"px",o.id=s+"1";const h=this.#s.get(o.id);h&&(o.style.backgroundColor=h),this.#l.push(o),e.appendChild(o);const d=new c(e,o);d.line.classList.add("red"),this.#h.set([e,o],d);const u=this.#y(t[1],o,s+"1"),p=l+u-this.#n;return i.style.left=-p*(Math.sqrt(3)/2)-this.#n+"px",o.style.left=p*(Math.sqrt(3)/2)+this.#n+"px",l+u}else throw new SyntaxError("ミツマタが発生!")}stringify(){return this.#a(this.tree,"")}#a(t,e){const s=["#D6D848","#CC76D1","#4A9DF8"][e.length%3],i=n=>`<span style="color: ${s}">${n}</span>`;if(t.length===0){const n=this.#s.get(e);return n?`<span style="color: ${n};">0</span>`:"0"}else{if(t.length===1)return`${i("(")}${this.#a(t[0],e+0)}${i(")")}`;if(t.length===2)return`${i("[")}${this.#a(t[0],e+0)},${this.#a(t[1],e+1)}${i("]")}`}throw new SyntaxError("ミツマタが発生!")}isFractal(){return this.isSemiFractal()&&JSON.stringify(this.tree)===JSON.stringify(this.getCut(this.tree))}isSemiFractal(){let t=1;for(;;){const e=this.#g(this.tree,t);if(e.length===0)break;if(!e.every(n=>n.length===0)&&e.some(n=>n.length===0))return!1;const s=e[0].join();if(!e.slice(1).every(n=>n.join()===s))return!1;t++}return!0}#f(t){if(t.length===0)return 0;if(t.length===1){const e=this.#f(t[0]);return e===null?null:e+1}else if(t.length===2){const e=this.#f(t[0]),s=this.#f(t[1]);return e!==s||e===null?null:e+1}throw new Error("ミツマタが発生!")}#g(t,e){if(e===1){if(t.length===1)return[t[0]];if(t.length===2)return[t[1]]}if(t.length===0)return[];if(t.length===1)return this.#g(t[0],e-1);if(t.length===2)return[...this.#g(t[0],e-1),...this.#g(t[1],e-1)];throw new Error("なんかおかしい!")}folder(){this.#o(this.tree,this.#e)}#o(t,e,s=0,i=""){const n=document.createElement("button");n.innerHTML=`${this.#a(t,i)}`;const r=document.createElement("div");r.classList.add("hidden","layer"),r.dataset.depth="2em";let l=!1;const o=()=>{if(l=!0,t.length===1){const h=document.createElement("span");h.textContent="...",h.classList.add("dot"),r.appendChild(h),this.#o(t[0],r,s+1,i+0),this.#o(t[0],r,s+1,i+0),this.#o(t[0],r,s+1,i+0);const d=document.createElement("span");d.textContent="...",d.classList.add("dot"),r.appendChild(d)}else if(t.length===2){this.#o(t[0],r,s+1,i+0),this.#o(t[1],r,s+1,i+1),this.#o(t[1],r,s+1,i+1),this.#o(t[1],r,s+1,i+1);const h=document.createElement("span");h.textContent="...",h.classList.add("dot"),r.appendChild(h)}};n.onclick=()=>{l||o(),r.classList.toggle("hidden")},e.appendChild(n),e.appendChild(r)}}document.addEventListener("DOMContentLoaded",async()=>{const a=document.getElementById("container"),t=document.getElementById("info"),e=new y(a,t);e.display();const s=document.getElementById("form"),i=document.getElementById("input"),n=document.getElementById("divide");n.onclick=()=>{e.divide()};const r=document.getElementById("cut");r.onclick=()=>{e.cut()};const l=document.getElementById("copy");l.onclick=()=>{i.value=JSON.stringify(e.tree)},document.getElementById("undo").onclick=()=>{e.undo()},window.addEventListener("keydown",o=>{o.ctrlKey&&o.code==="KeyZ"&&e.undo(),o.ctrlKey&&o.code==="KeyY"&&e.redo(),o.ctrlKey&&o.code==="KeyC"&&navigator.clipboard.writeText(JSON.stringify(e.tree))}),document.getElementById("redo").onclick=()=>{e.redo()},window.tree=e,s.onsubmit=o=>{o.preventDefault();const h=i.value.replaceAll(`
`,"").replaceAll("0","[]").replaceAll("(","[").replaceAll(")","]");e.tree=JSON.parse(h),e.display()}});
//# sourceMappingURL=run.js.map
